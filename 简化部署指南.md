# 简化云端部署指南

本指南使用免费的PaaS平台，无需自己管理服务器，适合快速部署。

## 部署架构

- **前端**：Vercel（免费，自动部署）
- **后端**：Railway 或 Render（免费额度）
- **数据库**：Railway PostgreSQL 或 Supabase（免费）

## 部署前准备

### 1. 注册账号（免费）

- **Vercel**：https://vercel.com（使用GitHub账号登录）
- **Railway**：https://railway.app（使用GitHub账号登录）
- **Supabase**（可选）：https://supabase.com（如果不用Railway数据库）

### 2. 准备GitHub仓库

1. 在GitHub创建新仓库（如：`thread-calculator`）
2. 将本地代码推送到GitHub：

```bash
cd "/Users/Zhuanz/cursor/用线计算器"

# 添加远程仓库（替换YOUR_USERNAME和YOUR_REPO）
git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO.git

# 推送代码
git branch -M main
git push -u origin main
```

---

## 方案一：Railway（推荐，最简单）

Railway 可以同时部署后端和数据库，一个平台搞定。

### 步骤1：部署后端和数据库到Railway

1. **登录Railway**
   - 访问 https://railway.app
   - 使用GitHub账号登录

2. **创建新项目**
   - 点击 "New Project"
   - 选择 "Deploy from GitHub repo"
   - 选择您的仓库

3. **添加PostgreSQL数据库**
   - 在项目页面点击 "+ New"
   - 选择 "Database" → "Add PostgreSQL"
   - Railway会自动创建数据库并设置环境变量

4. **配置后端服务**
   - Railway会自动检测到 `server/` 目录
   - 如果没检测到，手动设置：
     - **Root Directory**: `server`
     - **Build Command**: `npm install && npm run build`
     - **Start Command**: `npm start`

5. **配置环境变量**
   在Railway项目的 "Variables" 标签页添加：
   ```
   DATABASE_URL=<Railway自动生成的，不需要手动添加>
   PORT=3000
   NODE_ENV=production
   CORS_ORIGIN=https://your-frontend.vercel.app
   ```
   **注意**：`DATABASE_URL` Railway会自动提供，不需要手动添加。

6. **运行数据库迁移**
   - 在Railway的后端服务中，点击 "Deployments"
   - 选择最新的部署
   - 点击 "View Logs"
   - 在日志中找到Railway提供的数据库连接信息
   - 或者使用Railway CLI：
     ```bash
     # 安装Railway CLI
     npm i -g @railway/cli
     
     # 登录
     railway login
     
     # 连接到项目
     railway link
     
     # 运行迁移
     cd server
     railway run npm run prisma:migrate
     ```

7. **获取后端URL**
   - 部署成功后，Railway会提供一个URL（如：`https://xxx.up.railway.app`）
   - 记下这个URL，后面配置前端需要用到

### 步骤2：部署前端到Vercel

1. **登录Vercel**
   - 访问 https://vercel.com
   - 使用GitHub账号登录

2. **导入项目**
   - 点击 "Add New..." → "Project"
   - 选择您的GitHub仓库
   - 点击 "Import"

3. **配置项目**
   - **Framework Preset**: Vite
   - **Root Directory**: `client`
   - **Build Command**: `npm run build`
   - **Output Directory**: `dist`
   - **Install Command**: `npm install`

4. **配置环境变量**
   在 "Environment Variables" 中添加：
   ```
   VITE_API_BASE_URL=https://your-backend.railway.app/api
   ```
   将 `your-backend.railway.app` 替换为Railway提供的后端URL。

5. **部署**
   - 点击 "Deploy"
   - 等待部署完成
   - Vercel会提供一个URL（如：`https://xxx.vercel.app`）

6. **更新后端CORS配置**
   - 回到Railway，更新后端环境变量：
     ```
     CORS_ORIGIN=https://xxx.vercel.app
     ```
   - 重新部署后端服务

### 步骤3：完成！

现在您可以通过Vercel提供的URL访问应用了！

---

## 方案二：Render + Supabase

如果Railway不可用，可以使用Render部署后端，Supabase提供数据库。

### 步骤1：创建Supabase数据库

1. **登录Supabase**
   - 访问 https://supabase.com
   - 创建新项目
   - 记下数据库连接信息（在Settings → Database中）

2. **获取数据库URL**
   - 格式：`postgresql://postgres:[PASSWORD]@db.xxx.supabase.co:5432/postgres`
   - 将 `[PASSWORD]` 替换为您的数据库密码

### 步骤2：部署后端到Render

1. **登录Render**
   - 访问 https://render.com
   - 使用GitHub账号登录

2. **创建Web Service**
   - 点击 "New +" → "Web Service"
   - 选择您的GitHub仓库
   - 配置：
     - **Name**: thread-calculator-api
     - **Root Directory**: `server`
     - **Environment**: Node
     - **Build Command**: `npm install && npm run build`
     - **Start Command**: `npm start`

3. **配置环境变量**
   ```
   DATABASE_URL=postgresql://postgres:xxx@db.xxx.supabase.co:5432/postgres
   PORT=10000
   NODE_ENV=production
   CORS_ORIGIN=https://your-frontend.vercel.app
   ```
   **注意**：Render默认使用端口10000，不要改。

4. **部署**
   - 点击 "Create Web Service"
   - 等待部署完成
   - 记下提供的URL（如：`https://xxx.onrender.com`）

5. **运行数据库迁移**
   ```bash
   # 在本地运行（使用Supabase的DATABASE_URL）
   cd server
   DATABASE_URL="postgresql://..." npx prisma migrate deploy
   ```

### 步骤3：部署前端到Vercel

参考方案一的步骤2，将 `VITE_API_BASE_URL` 设置为Render的后端URL。

---

## 数据库迁移到生产环境

### 使用Railway数据库

```bash
# 安装Railway CLI
npm i -g @railway/cli

# 登录
railway login

# 连接到项目
cd server
railway link

# 运行迁移
railway run npx prisma migrate deploy
```

### 使用Supabase数据库

```bash
cd server

# 设置环境变量
export DATABASE_URL="postgresql://postgres:password@db.xxx.supabase.co:5432/postgres"

# 运行迁移
npx prisma migrate deploy
```

---

## 常见问题

### 1. Railway免费额度限制

Railway免费额度：
- $5/月免费额度
- 适合小型应用
- 如果超出，需要升级付费

### 2. Render服务休眠

Render免费服务在15分钟无活动后会休眠，首次访问需要等待唤醒（约30秒）。

解决方案：
- 升级到付费计划（$7/月）
- 使用Railway（无休眠问题）

### 3. CORS错误

确保：
1. 后端 `CORS_ORIGIN` 环境变量包含前端URL
2. URL末尾不要有斜杠（`https://xxx.vercel.app` 而不是 `https://xxx.vercel.app/`）
3. 重新部署后端服务

### 4. 数据库连接失败

确保：
1. `DATABASE_URL` 格式正确
2. 数据库允许外部连接（Railway/Supabase默认允许）
3. 运行了数据库迁移

### 5. 前端无法连接到后端

检查：
1. `VITE_API_BASE_URL` 是否正确
2. 后端服务是否正常运行
3. 浏览器控制台是否有错误信息

---

## 推荐的最终方案

**推荐使用Railway**：
- ✅ 一个平台搞定后端+数据库
- ✅ 无休眠问题
- ✅ 配置简单
- ✅ 免费额度足够小型应用使用

**工作流程**：
1. Railway部署后端+数据库
2. Vercel部署前端
3. 配置环境变量
4. 运行数据库迁移
5. 完成！

---

## 需要帮助？

如果在部署过程中遇到问题，请告诉我：
1. 使用的平台（Railway/Render）
2. 错误信息
3. 执行到哪一步

我会帮您解决！

